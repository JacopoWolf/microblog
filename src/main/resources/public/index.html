<!DOCTYPE html>
<html>
    <head>
        <title>Microbloggologgo</title>
        <link rel="stylesheet" href="style/default.css">
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
        <!-- main script -->
        <script>

            var APP = 
            {
                // global variables

                pagesize    : 4,
                page        : 0,
                currentpage : 'create',
                currentpost : -1,

                // pages methods

                changecontext : function(context)
                {
                    switch (context) {
                        case 'view':
                            $('#postcontainer').css('display','block');
                            $('#postcreator').css('display','none');
                            APP.currentpage = context;
                            break;

                        case 'create':
                            $('#postcontainer').css('display','none');
                            $('#postcreator').css('display','block');
                            APP.currentpage = context;
                            break;
                        default:
                            break;
                    }
                },

                // loading methods

                loadpage : function ( page, forw )
                {
                    if (page != null)
                        APP.page = page;

                    // controlla la validit√† delle variabili
                    if (forw != null)
                        if (forw)
                            APP.page+=1;
                        else
                            APP.page-=1;

                    if (APP.page < 0)
                        APP.page = 0;

                    var p = parseInt(APP.page);
                    var s = parseInt(APP.pagesize);

                        
                    $.get( '/rest/posts?count=' + s + '&page=' + p + '&limitcontent=' + 40 , function(data)
                    {
                        APP.displayMany( data )
                    });

                },

                loadpost : function ( id )
                {
                    $.get( '/rest/posts/' + id, function(data) 
                    {   
                        APP.displayPost( data );
                    });

                    $.get('/rest/posts/' + id + '/comments', function(data)
                    {
                        APP.displayComments( data );
                    });
                },

                // creation methods

                submituser : function ()
                {
                    var name = $('#c_username').val();
                    var mail = $('#c_email').val();

                    $.ajax
                    ({
                        url : "/rest/users",
                        type: "POST",
                        data: JSON.stringify({ username: name, email: mail }),
                        contentType: "application/json",
                        success: function()
                            {
                                alert("nuovo utente creato!")
                            }
                    }).fail(function(a,b,c){alert(  a.responseText   )});

                    /*$.post
                    ( 
                        '/rest/user', 
                        {
                            username: name,
                            email: mail
                        }
                    ).fail(function(a,b,c){alert(  a.responseText   )});*/
                },

                submitpost : function()
                {
                    try
                    {
                        APP.submituser();
                    }
                    finally
                    {

                    }
                },

                submitcomment : function()
                {
                    //todo implement
                },
                
                // display methods

                clear : function ()
                {
                    $("#postcontainer").html("");
                },

                displayPost : function( post )
                {
                    APP.clear();
                    $('#pagecount').html( '<i><b>(' + APP.page + ')</b></i>' );

                    var pt = $('#templates').find('.singlepost').clone();

                    pt.find('.singlepost_h').html( post['date'] );
                    pt.find('.singlepostheader_usrn').html( post['author']['username'] );
                    pt.find('.singlepostheader_t').html( post['title'] );
                    pt.find('.singlepostcontent_p').html( post['content'] );

                    $('#postcontainer').append( pt );

                    APP.currentpost = post['id'];
                },

                displayComments : function( data )
                {
                    $.each( data, function(i,v)
                    {
                        var cmt = $('#templates').find('.comment').clone();

                        cmt.find('.postheader').html( '<b>' + v['author']['username'] + '</b> on ' + v['date'] );
                        cmt.find('.postcontent').html( v['content'] )

                        $('#postcontainer').append( cmt )

                    });
                },

                displayMany : function ( data, comments )
                {
                    APP.clear();  
                    $('#pagecount').html(APP.page);
                    
                    $.each(data,function(i,v)
                    {
                        var pt = $('#templates').find('.post').clone();

                        pt.find('.postheader').html( '<b>' + v['author']['username'] + '</b> on ' + v['date'] );

                        pt.find('.postcontent_h').html(v['title'])
                        pt.find('.postcontent_h').click( function(){APP.loadpost(v['id'])} );

                        pt.find('.postcontent_p').html(v['content'] + '...');

                        $('#postcontainer').append( pt );
                    });
                },


                // for malefic testing purposes. 
                test : function()
                {
                    alert('funzionaaaaa mhuhuhahaha');
                }

            }

            $(document).ready( function() 
            { 
                APP.changecontext('view');
                APP.loadpage(0,null);

                // event binding
                $('#btn_back').click(function(){APP.loadpage(null,false)});
                $('#btn_forw').click(function(){APP.loadpage(null,true)});
                $('#pagespan').click(function(){APP.loadpage(0,null)});
                $('#pagecount').click(function(){APP.loadpage(null,null)});
                $('#btn_create').click(function(){APP.changecontext('create')});
            });

        </script>
    </head>
    <body>
        <div class="options">
            <button id="btn_back">Indietro</button>
            <span id="pagespan"><i><b>Page: </b></i></span><span id="pagecount">0</span>
            <button id="btn_forw">Avanti</button>
            <button>Cerca</button>
            <button id="btn_create">Crea</button>
        </div>
        <div class="content">
            <div class="title">
                <h1>Microbloggologgo</h1>
            </div>
            <div class="main" id="postcontainer" style="display: none;">

                <!--content goes here-->
                
            </div>

            <!-- post creator -->
            <div class="main" id="postcreator" style="display: none;">
                <button style="float: right; position: relative;" onclick="APP.changecontext('view')"><h2>Indietro</h2></button>
                
                <h2>Scrivi un post</h2>
                <div class="line"></div>
                
                    nome utente<br> <input type="text" autocomplete="username" id="c_username"><br>
                    e-mail<br><input type="text" autocomplete="email" id="c_email"><br><br>
                    TITOLO<br> <input type="text" class="long" id="c_title"><br>
                    <button style="float: right;" onclick="APP.submitpost()"><h2>Invia</h2></button>
                    CONTENUTO<br><textarea class="long" rows="20" id="c_content"  style="resize: vertical;"></textarea>
                
            </div>

            <footer>
                <p>Please don't attempt at contacting me since I want to be left alone. Thanks.</p>
                <p>copyright &copy Comparin Jacopo 2020</p>
            </footer>

        </div>

        <!-- TEMPLATES for js generation go here -->
        <div id="templates" style="display: none;">
        
            <!-- post when in lib -->
            <div class="post">
                <div class="postheader">AUTHOR on DATE</div>
                <div class="postcontent">
                    <h3 class="postcontent_h">TITLE</h3>
                    <p class="postcontent_p">CONTENT</p>
                </div>
            </div>

            <!-- post when focused -->
            <div class="singlepost">
                <p class="singlepost_h">DATE</p>
                <div class="singlepostheader">
                    <b><p class="singlepostheader_usrn">USERNAME</p></b>
                    <h2 class="singlepostheader_t">TITLE</h2>
                </div>
                <div class="singlepostcontent">
                    <p class="singlepostcontent_p">CONTENT</p>
                </div>
                
                <div class="line"></div>

            </div>

            <!-- comment on focused post -->
            <div class="comment">
                <div class="postheader">AUTHOR on DATE</div>
                <div class="postcontent">CONTENT</div>
            </div>

        </div>
    </body>
</html>